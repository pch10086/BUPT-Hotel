## 可直接使用的代码生成提示词（基于 Spring Boot + Vue.js + MySQL + MQTT）

> 你现在是一个资深软件架构师兼全栈工程师，精通 Java、Spring Boot、Vue.js、关系型数据库、并发调度和计费系统实现。  
> 请使用 **Java 17 + Spring Boot** 构建后端 RESTful API，使用 **Vue.js 3** 构建多角色 Web 前端，使用 **MySQL** 作为持久化存储，使用 **MQTT 协议** 作为“房间空调设备/面板”与服务器之间的轻量级实时消息通道，为下面的软件工程课程项目实现一个**完整可运行的原型系统**。

---

### 0. 技术栈与总体架构约束（必须满足）

1. **后端：Spring Boot**
   - 提供 RESTful API（JSON），按分层架构组织：Controller / Service / Domain / Repository。
   - 与 MySQL 集成（使用 JPA 或 MyBatis 均可），提供数据库初始化脚本或自动建表。
   - 集成 MQTT 客户端（如 Eclipse Paho），用于订阅/发布房间空调控制与状态主题。
   - 实现核心业务逻辑：调度、温度变化模拟、计费、账单与详单生成、统计报表等。

2. **前端：Vue.js 3**
   - 使用 Vue CLI 或 Vite 搭建 SPA 应用。
   - 至少实现三个可切换角色视图：  
     - 客户（GUEST，房间控制面板）  
     - 前台（CLERK）  
     - 经理/管理员（MANAGER/ADMIN）
   - 使用 Axios 调用后端 RESTful API。  
   - 客户视图可直接通过 HTTP 调用后端或模拟通过 MQTT（由后端代发设备指令），但需在提示词中明确前后端交互方式。

3. **数据库：MySQL**
   - 存储：  
     - 房间基础信息（房间号、初始温度、房价/每天等）  
     - 房间当前状态（模式、目标温度、风速、开关机等）  
     - 空调使用日志（详单）  
     - 空调账单（每次入住对应的空调费用汇总）  
     - 住宿费账单（包含入住天数与住宿总费用）  
   - 需设计合理的数据表结构和主外键关系。

4. **通信协议：MQTT**
   - 模拟“房间空调控制面板/设备”与服务器的消息交互：
     - 建议约定主题，如：  
       - `hotel/ac/room/{roomId}/command`：客户端（Vue 或设备模拟模块）发布控制命令。  
       - `hotel/ac/room/{roomId}/status`：服务器发布当前状态/推送结果。  
     - 消息体使用 JSON，包含房间号、操作类型（开机、关机、调温、调风）、模式、目标温度、风速等。
   - Spring Boot 后端需要编写 MQTT 连接配置和监听/发送封装服务，以便：  
     - 接收来自“房间设备”的控制请求（可以视为与 REST 请求等价的另一种入口）。  
     - 向设备推送最新空调状态（如调度结果、当前温度、费用变化等）。
   - 若实现真实 MQTT 客户端较复杂，可以用一个“设备模拟模块”（Java 程序或前端脚本）简化实现，但要在代码中清晰体现 MQTT 通道及其消息格式。

---

### 一、项目背景与总体目标

1. 要实现的是一个“**快捷廉价酒店中央空调自助计费系统**”的原型，用于软件工程课程作业的“软件原型实现”环节。
2. 酒店有多间客房（数量为参数 `X`），由一个**中央空调系统**统一供冷/供热。
3. 酒店推行“**自助计费式中央温控系统**”：  
   - 每个客房里有一个“空调客户端控制面板”（在本项目中用 Vue.js Web 页或设备模拟界面实现），由**客户（住客）**操作：  
     - 开关机  
     - 选择 **制冷模式/制热模式**  
     - 设置目标温度  
     - 设置风速（高风 / 中风 / 低风）  
     - 实时显示：当前房间温度、目标温度、当前风速、已产生费用等  
   - 所有房间的请求统一发送到后台的“中央空调服务端”（Spring Boot），由其负责**调度、温度变化模拟、计费、账单生成、统计报表**。
4. **前台营业员（酒店前台）**在客人退房时可以查询该房间的空调使用情况：  
   - 输出一张**空调账单（总金额）**  
   - 输出一张**空调详单（包含多条使用记录：每一段送风区间的起止时间、风速、费用等）**  
5. **空调管理员/酒店经理**可以实时监控各房间空调的使用状态（例如：当前是否在送风、模式、风速、当前温度、累计费用等），并按指定时间范围查看格式化的**统计报表**（例如：某天/某时间段内各房间耗电量、费用统计、风速分布、使用次数等）。
6. 系统需要能够通过读取/配置“制冷测试用例”和“制热测试用例”中的参数来完成验收测试，因此在实现中要将关键参数（温控范围、缺省目标温度、风速温度变化率、回温规则等）设计为**可配置常量或配置表**。

---

### 二、业务规则与物理约束（结合 Excel 测试用例的具体要求）

#### 1. 温度控制范围与默认值（制冷 / 制热分开）

1. **制冷模式（根据制冷测试用例 Excel）：**
   - 温控范围：**18℃–28℃**。  
   - 缺省目标温度：**25℃**。  
   - 房间初始温度示例（可作为测试默认配置写入数据库）：  
     - 房间一：32℃，房价 100 元/每天  
     - 房间二：28℃，房价 125 元/每天  
     - 房间三：30℃，房价 150 元/每天  
     - 房间四：29℃，房价 200 元/每天  
     - 房间五：35℃，房价 100 元/每天  

2. **制热模式（根据制热测试用例 Excel）：**
   - 温控范围：**18℃–25℃**。  
   - 缺省目标温度：**22℃**。  
   - 房间初始温度示例（可作为测试默认配置写入数据库）：  
     - 房间一：10℃，房价 100 元/每天  
     - 房间二：15℃，房价 125 元/每天  
     - 房间三：18℃，房价 150 元/每天  
     - 房间四：12℃，房价 200 元/每天  
     - 房间五：14℃，房价 100 元/每天  

3. 校验要求：  
   - 用户在制冷模式下设置的目标温度必须在 18–28℃，制热模式下必须在 18–25℃。  
   - 若设置超出范围，前端需提示错误，后端也必须做参数校验，防止非法值进入系统。

#### 2. 计费与风速能耗标准（以 Excel 参数为准）

1. 计费费率：**1 元 / 1℃**。  
   - 这里的“1℃”指按照风速配置中“温度变化速率”折算出来的单位温控能耗。可以将“风速 × 持续时间”折算为“等效温度变化度数”，再乘以单价。

2. 风速与温控速率（制冷/制热均使用相同配置）：
   - 高风：每 **1 分钟** 温度变化 **1℃**（朝目标温度方向变化）。  
   - 中风：每 **2 分钟** 温度变化 **1℃**（缺省风速）。  
   - 低风：每 **3 分钟** 温度变化 **1℃**。  

3. 费用计算：  
   - 在每个计费周期内，根据风速对应的温度变化速率与服务持续时间，折算出“等效温控度数”，乘以单价（1 元/1℃）得到费用增量。  
   - 计费应仅在“送风服务实际进行”的时间段内累积，房间处于回温或关机但未送风状态时不计费。

4. 每一段**送风会话**（从某次开始送风到停止送风为止）需要记录为一条明细，并最终映射到“详单”记录中。

#### 3. 温度变化与回温模型（与 Excel 说明保持一致）

1. 定义“**逻辑时间刻度**”：  
   - 测试用例表格中的每一行表示 **1 分钟** 的逻辑时间。  
   - 为了减少实际测试时间，在运行系统时可以将 **1 分钟逻辑时间压缩为 10 秒真实时间**。  
   - 写入数据库的时间相关字段（如服务时长）仍然按“正常分钟/秒”逻辑计算，不受压缩影响（例如：10 秒真实时间 = 60 秒逻辑时间）。

2. **送风状态下的温度变化：**
   - 制冷模式：当前温度 > 目标温度时，温度按风速速率向目标温度下降；接近或达到目标温度后停止送风。  
   - 制热模式：当前温度 < 目标温度时，温度按风速速率向目标温度上升；接近或达到目标温度后停止送风。  
   - 可以用“每 tick（逻辑 1 分钟）改变多少度”的方式实现，并且要保证多风速、多模式下的曲线能够与测试用例中的预期数据相匹配或易于对比。

3. **到达目标温度后的暂停与回温算法（Excel 明确要求）：**
   - 当房间室温达到目标温度（可视为达到或略微超过/低于某个阈值）时：  
     - 暂停送风服务，记录本次送风会话结束。  
     - 房间启动“回温程序”：**每分钟回温 0.5℃**（制冷时回升、制热时回落）。  
   - 当室温相对于目标温度**回温 1℃** 时（例如制冷模式下从 25℃ 回升到 26℃）：  
     - 自动重新发送“开始送风”请求，**请求参数保持与暂停时的一致**（模式、目标温度、风速不变）。  
     - 形成新的送风会话，并重新参与调度。

4. **关机状态下的回温算法（Excel 明确要求）：**
   - 当房间空调被关机（电源关闭），房间温度不再受目标温度控制：  
     - 房间温度以 **每分钟 0.5℃** 的速率逐渐回归到该房间的“初始温度”（而不是统一的环境温度）。  
     - 例如：制冷测试中房间二的初始温度为 28℃，则关机后的回温最高回到 28℃。  
   - 关机状态下无任何送风会话与计费。

5. **按钮防抖规则（保持与原要求一致）：**
   - 温度调节按钮：若用户在短时间内连续多次点击，且两次点击间隔 **小于 1 秒**，客户端只向服务端 / MQTT 发送**最后一次**调整参数。  
   - 若两次调整间隔 **大于等于 1 秒**，则每一次调整都发送请求。  
   - **调节风速**算作一次新的“送风请求”（会触发调度和可能的抢占）。  
   - 仅调整目标温度（不改变风速）**不算新的送风请求**，只影响该房间下一阶段温控行为。

---

### 三、资源限制与调度策略（优先级 + 固定时间片）

设定：  
- 酒店共有 `X` 间客房（可配置），房间编号如 1..X。  
- 中央空调服务端同一时刻最多只能为 `Y` 间房间提供送风（`X > Y`）。  
- 使用一个 **调度对象（Scheduler/DispatchController）** 和若干 **服务对象（ServiceUnit）** 来实现**优先级调度 + 时间片调度**组合策略。  
- **时间片长度固定为 2 分钟逻辑时间**（根据 Excel 中“等待队列中的对象被分配 2mins 时长”的说明）。  
  - 若采用“1 分钟逻辑时间 = 10 秒真实时间”的加速方式，则 1 个时间片 = 20 秒真实时间。

#### 1. 对象职责划分（与技术栈结合）

1. **Scheduler / DispatchController（后端领域服务）**
   - 在 Spring Boot 应用启动时初始化。  
   - 维护两个队列：  
     1. 服务队列（Service Queue）：记录当前正在被服务的房间：`房间号、服务对象ID、当前风速、累计服务时长`。  
     2. 等待队列（Waiting Queue）：记录等待获得服务资格的房间：`房间号、风速、分配的等待服务时长（含剩余等待时间）`。  
   - 接收来自 REST API 和 MQTT 的“送风请求”（开机后的首次请求、自动重启请求、调风引起的新请求）。  
   - 根据当前服务对象数量、队列状态和新请求的风速，执行优先级 / 时间片调度。  
   - 提供接口给管理员/经理界面，用于实时查看服务队列与等待队列情况。

2. **ServiceUnit（服务对象）**
   - 表示一个具体的送风执行单元，与某个房间绑定。  
   - 按时间刻度更新房间温度和费用。  
   - 在达到目标温度、房间关机或被调度释放时，结束当前送风会话并生成一条详单记录。  
   - 在被释放时负责把房间挂起并移入等待队列。

3. **CentralACSystem / CentralAirConditioner（聚合根）**
   - 管理所有 `Room` 实例以及 Scheduler、ServiceUnit 集合。  
   - 提供统一的业务入口方法（供 Controller/MQTT 消息处理调用），如开机、关机、调温、调风等。

---

### 四、调度规则详细说明（结合“2mins 时间片”）

用风速定义优先级：**高风 > 中风 > 低风**。

#### 情形 1：当前服务对象数量 < 上限 Y
- 新的送风请求到达时，若当前正在服务的房间数 < Y：  
  - 直接为该请求房间分配一个空闲 ServiceUnit，进入服务队列。

#### 情形 2：当前服务对象数量 ≥ 上限 Y（需要调度）

设新请求房间风速为 `V_new`，服务队列中每个服务对象风速为 `V_i`，并记录每个的“累计服务时长”（以逻辑分钟或时间片为单位）。

##### 2.1 优先级调度（`V_new` 与 `V_i` 比较）

- 若存在某些服务对象 `V_i` **低于** `V_new`：  
  1. 若低于 `V_new` 的服务对象只有一个：  
     - 将其对应房间从服务队列中释放，移入等待队列，并为其分配 **2 分钟逻辑时间** 的等待时长；  
     - 将腾出的 ServiceUnit 分配给新请求房间，新房间进入服务队列。  
  2. 若有多个风速相同且低于 `V_new` 的服务对象：  
     - 在这些候选中选择“累计服务时长最长”的那个释放并移入等待队列，同样分配 2 分钟等待时长。  
  3. 若有多个服务对象低于 `V_new` 且风速等级不同：  
     - 优先选择“**风速最低**”的服务对象释放，再在同风速中比较累计服务时长。

- 若所有服务对象的风速 `V_i` **等于** `V_new`：  
  - 进入时间片调度（见 2.2）。

- 若 `V_new` **低于** 所有正在服务的房间风速：  
  - 新请求房间不能立即抢占，只能进入等待队列，分配 2 分钟等待时长（见 2.3）。

##### 2.2 时间片调度规则（风速相同）

当新请求风速与服务队列中正在运行的房间风速相同（例如都是中风）：

1. 将新请求房间加入等待队列，初始等待时间 = **2 分钟逻辑时间**，开始倒计时。  
2. 在其等待的 2 分钟内：  
   - 若**没有任何服务对象释放**（没有房间因到达目标温度、关机或被高优先级抢占而释放）：  
     - 当前等待房间倒计时到 0 时，从服务队列中选择“**累计服务时长最长**”的房间，将其移入等待队列，并为其重新分配 2 分钟等待时间；  
     - 释放的 ServiceUnit 分配给等待时间到 0 的房间。  
   - 若在等待期间有服务对象因目标温度达到或关机而释放：  
     - 从等待队列中选择“**等待时间最长**”的房间，立即为其分配释放的 ServiceUnit 并开始服务。  
   - 若等待期间出现更高风速的新请求导致该房间始终未被调度：  
     - 当其等待时间到 0 后，不一定能立即获得 ServiceUnit，而是：  
       - 继续留在等待队列中，但在同风速的等待请求中，优先级高于“等待时间尚未满 2 分钟”的请求。

##### 2.3 新请求风速更低的情况

- 当 `V_new` 低于所有正在服务的房间风速：  
  - 新请求房间直接进入等待队列，分配 2 分钟等待时间。  
  - 之后只有在某个 ServiceUnit 释放时，才按优先级规则参与调度。

---

### 五、系统角色与用例（结合前后端实现）

1. **客户（住客 / 客房终端，GUEST）**  
   - 通过 Vue 前端或模拟的“房间面板设备”（可使用 MQTT 模拟）进行操作：  
     - 开机 / 关机  
     - 切换制冷 / 制热模式  
     - 设置目标温度（带范围校验）  
     - 调节风速（高 / 中 / 低）  
     - 查看：当前温度、目标温度、当前风速、累计空调费用、本次入住的总空调费用（可选）。  

2. **前台营业员（CLERK）**  
   - 通过 Vue 前端访问后端 REST API：  
     - 查询房间当前状态与历史使用简要信息；  
     - 在客户退房时：  
       - 生成并展示/导出**空调账单**（总费用）；  
       - 生成并展示/导出**空调详单**（按时间段列出每次送风的详细记录）。  

3. **空调管理员 / 酒店经理（ADMIN / MANAGER）**  
   - 实时查看所有房间的空调运行状态：  
     - 是否正在送风  
     - 当前模式、风速、目标温度、当前温度  
     - 累计服务时长、累计空调费用  
     - 服务队列和等待队列概览  
   - 按时间范围查看统计报表：  
     - 总“温控能耗”（可用等效度数代替真正电量）与总费用；  
     - 各房间的费用排名；  
     - 各风速使用时间占比；  
     - 可用简单文本表格或图表形式输出。

4. **住宿费用与入住天数（新增 Excel 要求）**  
   - 每个房间一次“开机→关机”过程视为入住一天，对应一次空调账单和住宿账单。  
   - 住宿费按房间配置的“房价/每天”计算。  
   - 需要额外维护一张“系统住宿费账单”，字段：  
     - 房间号、入住时间、离开时间、入住天数、住宿总费用。

---

### 六、领域模型与类设计建议（结合技术栈）

在实现代码时，建议体现如下领域概念（以 Java 类/包形式组织）：

- `Room`：客房实体，包含房间号、当前温度、目标温度、当前风速、当前模式、开关机状态、初始温度、房价等。  
- `CentralACSystem`：中央空调系统聚合根，管理所有房间、Scheduler、ServiceUnit。  
- `Scheduler` / `DispatchController`：调度对象，实现上述优先级与时间片调度逻辑。  
- `ServiceUnit`：服务对象，表示一个“正在服务的房间”的执行单元。  
- `BillingRecord`（空调账单）与 `BillingDetail`（详单项）：  
  - `BillingDetail`：一次连续送风会话的记录。  
  - `BillingRecord`：某房间一次入住周期内空调费用的汇总。  
- `LodgingBill`：住宿费账单记录。  
- `ReportService`：统计报表领域服务。  
- `MqttService` / `MqttClientConfig`：封装 MQTT 连接、订阅和发布。  
- Web 层 Controller：按角色暴露 RESTful 接口，例如：`GuestController`、`ClerkController`、`ManagerController`。  

---

### 七、接口与操作契约（REST API + MQTT）

至少实现以下核心业务操作（可以是 Service 层方法 + REST Controller 接口 + MQTT 消息处理）：

- `powerOn(roomId, mode, targetTemp, fanSpeed)`：开机并请求送风。  
- `powerOff(roomId)`：关机，释放 ServiceUnit，将当前送风会话结束并计入详单。  
- `changeFanSpeed(roomId, newFanSpeed)`：调风，作为新的送风请求，触发调度。  
- `changeTargetTemperature(roomId, newTargetTemp)`：调温，不产生新的送风请求。需做范围校验与防抖处理。  
- `getCurrentStatus(roomId)`：获取房间当前温度、目标温度、模式、风速、是否在服务队列/等待队列中的状态。  
- `generateAcBill(roomId, timeRange)`：生成空调账单（总费用 + 简要说明）。  
- `generateAcDetailList(roomId, timeRange)`：生成空调详单列表。  
- `generateLodgingBill(roomId, timeRange)`：生成住宿费账单。  
- `exportBillAndDetail(roomId, timeRange, format)`：导出账单和详单到 TXT / Excel / PDF 文件。  
- 管理与报表类接口：  
  - 查询当前所有服务对象和等待队列。  
  - 按时间范围生成全局统计报表。  

所有这些操作都应清晰修改领域对象状态，并在 MySQL 中持久化，便于与用例/操作契约和 Excel 测试用例对比。

---

### 八、账单与详单字段格式（必须满足 Excel 要求）

1. **空调详单数据字段（严格限定字段）：**  
   - 每条详单记录字段必须为：  
     - 房间号  
     - 请求时间  
     - 服务开始时间  
     - 服务结束时间  
     - 服务时长（单位：秒）  
     - 风速  
     - 当前费用（本次会话产生的费用）  
     - 累积费用（截至当前会话的总空调费用）  
   - **验收输出的详单文件中，不允许出现其他额外字段列**（数据库中可有更多字段，但导出文件需严格按此格式）。

2. **空调账单数据字段：**  
   - 房间号  
   - 入住时间  
   - 离开时间  
   - 空调总费用  

3. **系统住宿费账单字段：**  
   - 房间号  
   - 入住时间  
   - 离开时间  
   - 入住天数（一次开机→关机 = 一天）  
   - 住宿总费用  

4. **账单和详单文件输出：**  
   - 要求以每个房间为单位输出对应的账单文件和详单文件。  
   - 文件格式可以是 TXT、Excel 或 PDF（至少实现一种，并在代码中明确实现方式）。  

---

### 九、时间模拟与测试场景

1. 时间模拟机制：  
   - 在后端实现统一的“逻辑时间驱动器”，例如使用 `ScheduledExecutorService` 每隔 N 毫秒执行一次：  
     - 推进逻辑时间 1 分钟；  
     - 更新所有 ServiceUnit 中的温度与费用；  
     - 更新等待队列中各房间的剩余等待时间；  
     - 判断是否触发自动停止送风或重新开始送风；  
     - 执行调度策略。  
   - 对于加速测试场景，建议设定：`10 秒真实时间 = 1 分钟逻辑时间`，但可通过配置项灵活调整。

2. 测试场景：  
   - 支持同时启动 5 个房间作为客户端，房间号可与小组号对应。  
   - 系统应支持根据提供的“制冷测试用例 / 制热测试用例”模拟操作序列（开机、关机、调风、调温等），并生成详单/账单，用于对照手工计算的理论结果。  

---

### 十、实现与输出格式要求（对代码生成模型的要求）

1. **总体结构：**
   - 先输出简要的系统架构说明与模块划分（前端、后端、数据库、MQTT 通道）。  
   - 再输出后端项目目录结构树（例如 `src/main/java/...` 包结构）和前端项目结构（`src/components`、`src/views` 等）。  

2. **代码输出顺序：**
   - 后端：  
     - 配置类（MQTT、数据源等）  
     - 领域实体与枚举  
     - Repository 接口  
     - Service 实现（含调度逻辑与时间模拟）  
     - Controller（REST API）  
   - 前端：  
     - 主入口（`main.js` / `main.ts`）  
     - 路由配置与角色切换框架  
     - 各角色的页面组件（客户、前台、经理）  
     - 与后端交互的 API 封装模块  
   - 数据库：  
     - 提供建表 SQL 脚本（MySQL）。  

3. **注释与说明：**
   - 在关键类、关键方法以及关键业务逻辑处使用**中文注释**说明其作用，并指明与哪一条业务规则或 Excel 要求对应。  

4. **若需做简化假设：**
   - 如对部分统计报表字段、图形展示、MQTT 客户端模拟方式等进行合理简化，请在代码注释中明确说明简化内容与原因。  

请严格依据以上业务规则、调度策略、Excel 参数与技术栈约束来设计并实现整个项目代码。  
生成代码时务必保证：结构清晰、职责划分合理、便于根据测试用例进行验证。
